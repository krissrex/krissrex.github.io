<!DOCTYPE html><html lang="en" class="antialiased box-border"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" href="/favicon.ico"><title>Watching my DNS records</title><meta name="keywords" content="blog, personal, technology, programming, Kristian Rekstad"><meta name="description" content="A script to email me if my public IP and DNS do not match."><meta name="author" content="Kristian Rekstad"><meta property="og:title" content="Watching my DNS records"><meta property="og:description" content="A script to email me if my public IP and DNS do not match."><meta property="og:locale" content="en"><meta property="og:site_name" content="Kristian's website"><link href="/assets/styles/main.30d21f798371f332d884.css" rel="stylesheet"><link rel="manifest" href="/site.webmanifest"><script type="text/javascript">var _paq=window._paq=window._paq||[];_paq.push(["setRequestMethod","POST"]),_paq.push(["setSecureCookie",!0]),_paq.push(["trackPageView"]),_paq.push(["enableHeartBeatTimer"]),_paq.push(["trackVisibleContentImpressions",!0,750]),_paq.push(["addDownloadExtensions","json"]),_paq.push(["enableLinkTracking"]),function(){var e="//stats.krex.no/",a=(_paq.push(["setTrackerUrl",e+"js/"]),_paq.push(["setSiteId","1"]),document),s=a.createElement("script"),a=a.getElementsByTagName("script")[0];s.type="text/javascript",s.async=!0,s.src=e+"js",a.parentNode.insertBefore(s,a)}()</script></head><body class="font-sans flex flex-col min-h-screen w-full"><noscript><p><img class="nolazy" src="//stats.krex.no/js/?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript><nav class="flex-initial p-4 mb-8 bg-indigo-600 text-white flex flex-wrap items-center border-b"><a href="/" class="flex text-white no-underline items-center flex-shrink-0"><img class="self-start h-8 w-8 mr-2 lazyload" src="/assets/images/logo.png" alt="logo" data-src="/assets/images/logo.png"><h1 class="text-xl font-semibold tracking-tight">Kristian's Website</h1></a></nav><main class="flex-auto sm:mw-2/3 mx-5 sm:mx-auto"><article class="post"><header><h1 class="font-normal text-3xl font-serif">Watching my DNS records</h1><div class="text-gray-600">October 19, 2020</div></header><section class="pt-3 pb-3 prose font-serif mx-auto"><blockquote><p><strong>Update 2020-11-17:</strong> I forced <code>curl</code> to use IPv4, as I sometimes got IPv6 back. And I added <code>Date</code> and <code>Message-ID</code> headers to email, as this reduces the SpamAssassin score (<a href="https://dkimvalidator.com/" target="_blank" rel="noopener noreferrer">I tested with this</a>).</p></blockquote><p>Home routers and ISPs are not always the best for hosting a website. One reason in particular, is the lack of static IP-addresses. So whenever my router restarts, I risk getting a new IP. Which in turn means the DNS records for this site (krex.no) become invalid! I could enable <a href="https://en.wikipedia.org/wiki/Dynamic_DNS" target="_blank" rel="noopener noreferrer">ddns</a>, but my router is behind NAT. (Yes, double NAT is bad, but I will clean that up at a later time).</p><p>So to fix this, I wanted to know when my IP has changed. And when it does, I want to get an email. Later on, I can update the DNS records automatically. My registrar has both and <a href="https://api.domeneshop.no/docs/#section/Overview" target="_blank" rel="noopener noreferrer">API</a> and <a href="https://github.com/domeneshop/domeneshop.js" target="_blank" rel="noopener noreferrer">API clients</a> available. But for now, I just want to <em>know</em>. The automatic DNS record updates can be dealt with later, when I get tired of manually updating them.</p><h2 id="sub-problems" tabindex="-1"><a class="header-anchor" href="#sub-problems" aria-hidden="true">ðŸ”—</a> Sub-problems</h2><p>Our problem has 3 parts:</p><ul><li>What IP does the DNS say we have?</li><li>What IP do we actually have? (The <em>dynamic</em>, public IP)</li><li>How do we email ourselves?</li></ul><h2 id="the-scripts" tabindex="-1"><a class="header-anchor" href="#the-scripts" aria-hidden="true">ðŸ”—</a> The scripts</h2><p>So first off, SSH into the server and create a folder: <code>ip-watch</code>.</p><h3 id="getting-our-ip" tabindex="-1"><a class="header-anchor" href="#getting-our-ip" aria-hidden="true">ðŸ”—</a> Getting our IP</h3><p>A <a href="https://github.com/xxdesmus" target="_blank" rel="noopener noreferrer">guy at cloudflare</a> made <a href="https://canhazip.com" target="_blank" rel="noopener noreferrer">canhazip.com</a> to easily get your ip. Put this into <code>current-ip.sh</code>:</p><pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><br><span class="token function">curl</span> --silent -4 canhazip.com</code></pre><p>The <code>-4</code> tells curl to use IPv4. Other alternatives:</p><pre><code>dig +short TXT o-o.myaddr.l.google.com @ns3.google.com
nslookup myip.opendns.com resolver1.opendns.com
</code></pre><p>However they might require some <code>grep</code>ing.</p><h3 id="getting-the-dns-ip" tabindex="-1"><a class="header-anchor" href="#getting-the-dns-ip" aria-hidden="true">ðŸ”—</a> Getting the DNS ip</h3><p>Some like <code>dig</code>, some like <code>nslookup</code>, but neither are pre-installed on my raspberry pi. Instead, we opt for <code>getent hosts</code>. Put this into <code>current-dns.sh</code>:</p><pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><br><br>getent hosts krex.no <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{ print $1 }'</span></code></pre><h3 id="sending-the-emails" tabindex="-1"><a class="header-anchor" href="#sending-the-emails" aria-hidden="true">ðŸ”—</a> Sending the emails</h3><p>I already set up postfix in docker using <a href="https://hub.docker.com/r/boky/postfix" target="_blank" rel="noopener noreferrer">boky/postfix</a> with <a href="https://github.com/bokysan/docker-postfix/issues/30" target="_blank" rel="noopener noreferrer">some tweaks</a> to make it run on a 32bit os. This adds a SMTP server on my localhost on port 25 and 587 (TLS). When I send email through this server, it can use OpenDKIM when sending the email, and this avoid some spam filters such as gmail's. <a href="https://mxtoolbox.com/SuperTool.aspx?action=dkim%3akrex.no%3amail&amp;run=toolpage" target="_blank" rel="noopener noreferrer">Here is my signature</a>.</p><p>To stitch the scripts together, I intend to make another script. So the DNS IP and current IP are sent from the command line. Put this in <code>email-warning.py</code>:</p><pre class="language-python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span><br><br><span class="token keyword">import</span> smtplib<br><span class="token keyword">from</span> email<span class="token punctuation">.</span>mime<span class="token punctuation">.</span>multipart <span class="token keyword">import</span> MIMEMultipart<br><span class="token keyword">from</span> email<span class="token punctuation">.</span>mime<span class="token punctuation">.</span>text <span class="token keyword">import</span> MIMEText<br><span class="token keyword">import</span> email<span class="token punctuation">.</span>utils<br><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<br><span class="token keyword">from</span> sys <span class="token keyword">import</span> argv<br><br><span class="token keyword">def</span> <span class="token function">send_email</span><span class="token punctuation">(</span>dns_ip<span class="token punctuation">,</span> current_ip<span class="token punctuation">)</span><span class="token punctuation">:</span><br>    <span class="token keyword">with</span> smtplib<span class="token punctuation">.</span>SMTP<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">587</span><span class="token punctuation">)</span> <span class="token keyword">as</span> s<span class="token punctuation">:</span><br>        msg <span class="token operator">=</span> MIMEMultipart<span class="token punctuation">(</span><span class="token punctuation">)</span><br>        body <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"DNS has ip </span><span class="token interpolation"><span class="token punctuation">{</span>dns_ip<span class="token punctuation">}</span></span><span class="token string">\nThe current ip is </span><span class="token interpolation"><span class="token punctuation">{</span>current_ip<span class="token punctuation">}</span></span><span class="token string">\n\nSent at </span><span class="token interpolation"><span class="token punctuation">{</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">."</span></span><br>        msg<span class="token punctuation">[</span><span class="token string">"From"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"DNS IP Watcher &lt;noreply@krex.no&gt;"</span><br>        msg<span class="token punctuation">[</span><span class="token string">"To"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"INSERT-YOUR-EMAIL-HERE@email.com"</span> <span class="token comment"># Change this line</span><br>        msg<span class="token punctuation">[</span><span class="token string">"Subject"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"[krex.no] DNS is invalid "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        msg<span class="token punctuation">[</span><span class="token string">"Date"</span><span class="token punctuation">]</span> <span class="token operator">=</span> email<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>formatdate<span class="token punctuation">(</span>localtime<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><br>        msg<span class="token punctuation">[</span><span class="token string">"Message-ID"</span><span class="token punctuation">]</span> <span class="token operator">=</span> email<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>make_msgid<span class="token punctuation">(</span>domain<span class="token operator">=</span><span class="token string">"krex.no"</span><span class="token punctuation">)</span><br>        msg<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>MIMEText<span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">'plain'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>        s<span class="token punctuation">.</span>send_message<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><br>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Sent message '%s' to %s. Message-ID: %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>msg<span class="token punctuation">[</span><span class="token string">"Subject"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> msg<span class="token punctuation">[</span><span class="token string">"To"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> msg<span class="token punctuation">[</span><span class="token string">"Message-ID"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">:</span><br>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Usage: </span><span class="token interpolation"><span class="token punctuation">{</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> dns_ip current_ip"</span></span><span class="token punctuation">)</span><br>        exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><br><br>    dns_ip <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><br>    current_ip <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><br>    <span class="token keyword">if</span> dns_ip <span class="token operator">!=</span> current_ip<span class="token punctuation">:</span><br>        send_email<span class="token punctuation">(</span>dns_ip<span class="token punctuation">,</span> current_ip<span class="token punctuation">)</span><br><br><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span><br>    main<span class="token punctuation">(</span><span class="token punctuation">)</span><br></code></pre><h3 id="the-final-glue" tabindex="-1"><a class="header-anchor" href="#the-final-glue" aria-hidden="true">ðŸ”—</a> The final glue</h3><p>The script which we will run with <code>cron</code> is called <code>do-check.sh</code>:</p><pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><br><br><span class="token assign-left variable">DNS</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>./current-dns.sh<span class="token variable">)</span></span><br><span class="token assign-left variable">IP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>./current-ip.sh<span class="token variable">)</span></span><br><br><span class="token builtin class-name">echo</span> <span class="token string">"Current DNS: <span class="token variable">$DNS</span>"</span><br><span class="token builtin class-name">echo</span> <span class="token string">"Current IP: <span class="token variable">$IP</span>"</span><br><br><span class="token builtin class-name">exec</span> ./email-warning.py <span class="token variable">$DNS</span> <span class="token variable">$IP</span></code></pre><p>Don't forget to make the files executable:</p><pre class="language-bash"><code class="language-bash"><span class="token function">chmod</span> +x *.sh *.py</code></pre><h2 id="running-it-daily" tabindex="-1"><a class="header-anchor" href="#running-it-daily" aria-hidden="true">ðŸ”—</a> Running it daily</h2><p><code>cron</code> has been mentioned already, and is perfect for this. Run <code>crontab -e</code> to edit the file, and add a new line:</p><pre><code># DNS/IP test every day at 13:00
0 13 * * * /home/pi/dev/ip-watch/do-check.sh
</code></pre></section><footer class="mb-12 mt-2 pt-2 border-t"><a href="/">Back to home</a></footer></article></main><script>
            (function (selector, src, preferNativeLazyLoad) {
  var images = document.querySelectorAll(selector);
  var numImages = images.length;

  if (numImages > 0) {
    if (preferNativeLazyLoad && 'loading' in HTMLImageElement.prototype) {
      for (var i = 0; i < numImages; i++) {
        var keys = ['src', 'srcset'];

        for (var j = 0; j < keys.length; j++) {
          if (images[i].hasAttribute('data-' + keys[j])) {
            var value = images[i].getAttribute('data-' + keys[j]);
            images[i].setAttribute(keys[j], value);
          }
        }
      }

      return;
    }

    var script = document.createElement('script');
    script.async = true;
    script.src = src;
    document.body.appendChild(script);
  }
})(
              'img:not(.nolazy)',
              'https://cdn.jsdelivr.net/npm/lazysizes@5/lazysizes.min.js',
              false
            );
          </script></body></html>