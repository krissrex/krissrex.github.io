<!DOCTYPE html><html lang="en" class="antialiased box-border"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" href="/favicon.ico"><title>Kotlin Value Classes and Mangled Handlebars ViewModels</title><meta name="keywords" content="blog, personal, technology, programming, Kristian Rekstad"><meta name="description" content="How to avoid mangling when using Handlebars in Kotlin"><meta name="author" content="Kristian Rekstad"><meta property="og:title" content="Kotlin Value Classes and Mangled Handlebars ViewModels"><meta property="og:description" content="How to avoid mangling when using Handlebars in Kotlin"><meta property="og:locale" content="en"><meta property="og:site_name" content="Kristian's website"><meta property="og:type" content="article"><meta property="article:published_time" content="2024-07-18T21:00:33.000Z"><script type="application/ld+json">{
"description": "How to avoid mangling when using Handlebars in Kotlin",
"author": { "@type": "Person", "name": "Kristian Rekstad" },
"@type": "BlogPosting",
"url": "https://krex.no/kotlin-value-classes-and-mangled-handlebars-viewmodels/",
"publisher": {
"@type": "Organization",
"logo": {
"@type": "ImageObject",
"url": "https://krex.no/assets/images/logo.png"
},
"name": "Kristian Rekstad"
},
"headline": "Kotlin Value Classes and Mangled Handlebars ViewModels",
"datePublished": "2024-07-18T21:00:33.000Z",
"mainEntityOfPage": {
"@type": "WebPage",
"@id": "https://krex.no/kotlin-value-classes-and-mangled-handlebars-viewmodels/"
},
"@context": "http://schema.org"
}</script><link href="/assets/styles/main.css" rel="stylesheet"><link href="/assets/styles/prism-atom-dark.css" rel="stylesheet"><link rel="manifest" href="/site.webmanifest"></head><body class="font-sans flex flex-col min-h-screen w-full"><nav class="flex-initial p-4 mb-8 bg-indigo-600 text-white flex flex-wrap items-center border-b"><a href="/" class="flex text-white no-underline items-center shrink-0"><img class="self-start h-8 w-8 mr-2 lazyload" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC7ElEQVRIie2Uz0/TYBzGe/ToRYx/hgn/hIlXSeRHIP4HHlCOxJOJejExXgx6kATMDOrCEBiEMIbt2rHB1gLSbuvarV3brdyU1L2ved4VgW2abBpOHp5833zf5/t52u19y0mydl9StAVJURuSojbTikrOifYgcipwWjxtAXwOC1HWcnxe+7ad08jWRdEeRE4FDnjggs8hEY2VTJG+E3QykzTI66RB+9VM0iDggAcu+AhpIhkbz9Yr5GHMplNLNplaYrVXEcyDAx644HP4DfGKeAIYRiIeGY14tF+NRDzGAQ9c8H+F4FXxJDCOvXf71mjEYxzwfhdC/1EIbQ9hp6N7iNeD3G4h7Hj/D6G9/lyX8seTSzvCM+FlHI54ZKR1qfrScLfLKCkqu/7zgk6erFfI5KJNHsRsMtldtK1eEJtbtBln/uyzwkKO+bz2fXmnSOd4nb7aMv5ac7xOwQMXfIRERVmT8cVM5rRgc68A/WhTc3NPI51Cv8MbgBN+6mXwOVHRxiRFe5RW1Lm0on7cUdRPTPtsHf2yu5/alHKVNT7TXOMzdI3PkLA20cc+fKGfzYIDHrjgc6KsXhdl9WZKVm+nZHVIgPLqUEpW7wj5o7txYfdpLCFtRzeEILoh0OiGQMIaoI99+Fr+1jw44IELPjf9YpYrVJwrR0bt6qFuDUAHenXga9m+lteMG3E+O/F5S/oQS4gnsYRIYwmRhPUEfezDBz/mThnggTv98i3HlSxvsGR5t0qWN67b9Qkmi9XxkuXdUwrm8+xhUUgrWpBWcINxLFkN0Mc+fPCHc0zghdxBTrfrjw2n8cZ0/GXT8VdN1181ncaq6fgrpuPHy3Y9W7I8q1h1m4WqS4tVl4S1iT724Wv5G+E80zK44CPkwHR8t+L6tOIek6p3TCquH9bzax9inlY93+86R8EFnytZ9Yzp+NUQcmZmxs6QcN0Z0ukl4ILP6VZ9tlyrZ8u1RlCuNUhL9bC2rxu0rf7JG4AL/k95gNyedqan7QAAAABJRU5ErkJggg==" alt="logo" data-src="/assets/images/logo.png" width="192" height="192"><h1 class="text-xl font-semibold tracking-tight">Kristian's Website</h1></a></nav><main class="flex-auto sm:mw-2/3 mx-5 sm:mx-auto"><article class="post"><header><h1 class="font-normal text-3xl font-serif">Kotlin Value Classes and Mangled Handlebars ViewModels</h1><div class="text-gray-600">July 18, 2024</div></header><section class="pt-3 pb-3 prose font-serif mx-auto"><blockquote><p>TL;DR: <code>@get:JvmName("getName") val name: Username</code></p></blockquote><p>I recently started a project using Kotlin, Http4K and Handlebars. Setting this up and using it was quite straightforward:</p><pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// File: MyWebpage.kt</span>
<span class="token keyword">private</span> <span class="token keyword">val</span> renderer <span class="token operator">=</span> <span class="token function">HandlebarsTemplates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CachingClasspath</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"templates"</span></span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">val</span> bodyLens <span class="token operator">=</span> Body<span class="token punctuation">.</span><span class="token function">viewModel</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> ContentType<span class="token punctuation">.</span>TEXT_HTML<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLens</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">MyWebpage</span><span class="token punctuation">(</span><span class="token keyword">val</span> name<span class="token operator">:</span> Username<span class="token punctuation">)</span> <span class="token operator">:</span> ViewModel

<span class="token annotation builtin">@JvmInline</span>
value <span class="token keyword">class</span> <span class="token function">Username</span><span class="token punctuation">(</span><span class="token keyword">val</span> value<span class="token operator">:</span> String<span class="token punctuation">)</span>

<span class="token keyword">fun</span> <span class="token function">myEndpoint</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Response</span><span class="token punctuation">(</span>Status<span class="token punctuation">.</span>OK<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span>bodyLens of <span class="token function">MyWebpage</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token function">Username</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Kristian"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><p>and the template:</p><pre class="language-handlebars"><code class="language-handlebars">Hello <span class="token handlebars language-handlebars"><span class="token delimiter punctuation">{{</span><span class="token variable">name</span><span class="token delimiter punctuation">}}</span></span></code></pre><h2 id="and-this-works-great!" tabindex="-1"><a class="header-anchor" href="#and-this-works-great!" aria-hidden="true">ðŸ”—</a> And this works great!</h2><p><em>Except</em>, it doesn't.</p><p>If you run this code, Handlebars will mention that it can't find the helper <code>name</code> (given you enable logging or set a <code>missingHelper</code>).</p><p>How come?</p><p>Let's change the <code>MyWebpage</code> data class a tiny bit:</p><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">MyWebpage</span><span class="token punctuation">(</span><span class="token keyword">val</span> name<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token operator">:</span> ViewModel</code></pre><p>This time, it works! For real! So the <code>value class</code> is somehow screwing things up. Could it be that your template needs to say <code>{{name.value}}</code> to read inside the value class?</p><p>Nope! Same issue.</p><h2 id="it's-never-a-compiler-bug" tabindex="-1"><a class="header-anchor" href="#it's-never-a-compiler-bug" aria-hidden="true">ðŸ”—</a> It's never a compiler bug</h2><p>And no, it's not a compiler bug. But it <strong>is the compiler</strong>. You see, Handlebars is written in Java and looks in your <code>ViewModel</code> instance (<code>MyWebpage</code>) with <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Class.html#getDeclaredMethods--" target="_blank" rel="noopener noreferrer">getDeclaredMethods</a> (reflection).</p><p>Then it follows regular POJO rules, so when your template is referencing a <code>{{name}}</code>, Handlebars will look for a <code>getName</code> method.</p><p>When we use <code>val name: String</code> with the <code>String</code> type, this method exists, because kotlin adds it for Java interop, along with a private backing field.</p><p>But how come Handlebars can't find any <code>getName(): String</code> method when we use a <code>value class</code>?</p><h2 id="enter%3A-mangling" tabindex="-1"><a class="header-anchor" href="#enter%3A-mangling" aria-hidden="true">ðŸ”—</a> Enter: Mangling</h2><p>Kotlin has to do some smart tricks when you use value classes, to avoid creating methods that collide in the Java world.</p><p>As an example, the two methods <code>getName(): String</code> and <code>getName(): Username</code> are exactly the same, because we <code>@JvmInline</code> this <code>Username</code> class, and therefore replace any occurence of <code>Username</code> in bytecode with <code>String</code>.<br>So in Java, your kotlin code looks like <code>getName(): String</code> twice. And that's an issue! ðŸ’£</p><p>To solve this, the Kotlin compiler applies <a href="https://kotlinlang.org/docs/inline-classes.html#mangling" target="_blank" rel="noopener noreferrer">mangling</a> to the generated getter. (Digression: If you've used python before, perhaps you remember double underscore for <code>__my_internal_field</code>).<br>The method generated in bytecode is actually called: <code>getName-D0aAuEE(): String</code>.</p><p>You can see this by using the <em>Bytecode Viewer</em> or <em>Show bytecode</em> actions in IntelliJ: <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAACCAYAAACt+Hc7AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAdklEQVQImU2NOw7DMAzFehV/ZElPjpv7X44FkqUDwYUAP2cXW4kyCYmseuyeLBcemxXFsKB1o7XJnIbbIjyIEJ5vMy0ZM/5w+lh8TolLyS6xz8V1H/Y5SJvUQfsm64uFaGPR+8SmkctQBFKRdZ7mnb3Dx17YEj+vWklq6b/49wAAAABJRU5ErkJggg==" alt="Side-by-side of code and bytecode in IntelliJ" data-src="/assets/images/posts/value-class-mangled.png" class="lazyload" width="1764" height="130"></p><h2 id="so-how-do-we-fix-this%3F" tabindex="-1"><a class="header-anchor" href="#so-how-do-we-fix-this%3F" aria-hidden="true">ðŸ”—</a> So how do we fix this?</h2><p>I obviously do not want to edit my Handlebars template to say <code>{{name-D0aAuEE}}</code>.<br>So instead, we alter the generated bytecode using an annotation.</p><p>IntelliJ annotations on properties can affect the property itself, the backing field, or the getter or setter. In this case, we only care about the getter.<br>The annotation is targeting the getter using the <code>@get:</code> syntax.<br>To rename the generated method to a normal POJO style, Kotlin has a <code>JvmName("newName")</code> annotation.</p><p>So, to fix our issues, all we have to do (on every field of <code>value class</code> inside <code>MyWebpage</code>):</p><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">MyWebpage</span><span class="token punctuation">(</span><span class="token annotation builtin">@get:JvmName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"getName"</span></span><span class="token punctuation">)</span> <span class="token keyword">val</span> name<span class="token operator">:</span> Username<span class="token punctuation">)</span></code></pre><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAABCAYAAAArbAWVAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAUUlEQVQImRXD0QlCQQxFQQvKJrnZBFb0Q7AAwf57OY83MI8OY8ciI5GKqmR6sdtQO64gIgkX0qB9cA3mwmyRa1FuaD7o9SPff+p82fOk7n24AKLhJ7uxr+nYAAAAAElFTkSuQmCC" alt="Unmangled getter in bytecode" data-src="/assets/images/posts/value-class-unmangled.png" class="lazyload" width="1960" height="68"></p><p>And now Handlebars should render <code>Hello Kristian</code>.</p></section><footer class="mb-12 mt-2 pt-2 border-t"><a href="/">Back to home</a></footer></article></main><script>
            (function (selector, src, preferNativeLazyLoad) {
  var images = document.querySelectorAll(selector);
  var numImages = images.length;

  if (numImages > 0) {
    if (preferNativeLazyLoad && 'loading' in HTMLImageElement.prototype) {
      for (var i = 0; i < numImages; i++) {
        var keys = ['src', 'srcset'];

        for (var j = 0; j < keys.length; j++) {
          if (images[i].hasAttribute('data-' + keys[j])) {
            var value = images[i].getAttribute('data-' + keys[j]);
            images[i].setAttribute(keys[j], value);
          }
        }
      }

      return;
    }

    var script = document.createElement('script');
    script.async = true;
    script.src = src;
    document.body.appendChild(script);
  }
})(
              'img:not(.nolazy)',
              'https://cdn.jsdelivr.net/npm/lazysizes@5/lazysizes.min.js',
              false
            );
          </script></body></html>